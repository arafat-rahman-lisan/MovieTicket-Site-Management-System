@model Movie_Site_Management_System.ViewModels.Shows.ShowMapVM
@using Movie_Site_Management_System.Data.Enums
@{
    ViewData["Title"] = "Select Seats";
    ViewBag.GlassHeader = true;
    var grouped = Model.Seats.GroupBy(s => s.RowLabel).OrderBy(g => g.Key).ToList();
}

<div class="container py-3">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h3 class="mb-1">@Model.MovieTitle <span class="ms-1">🎬</span></h3>
            <div class="text-muted small">
                @Model.TheatreName — @Model.HallName
            </div>
        </div>
        <div class="text-muted text-end small">
            @Model.Date.ToString("dd MMM yyyy") • @Model.StartTime.ToString(@"hh\:mm")
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="alert alert-info glassy-alert mb-3">
        <strong>🍿 Tip:</strong> Click available seats to select. Selected seats appear in the cart below.
    </div>

    <!-- GLASS STAGE -->
    <div class="seat-stage glass-card position-relative">

        <!-- Emoji doodles (floating) -->
        <div class="doodles" aria-hidden="true">
            <span class="doodle" style="--x:10%;--y:8%;--d:6s">🍿</span>
            <span class="doodle" style="--x:86%;--y:12%;--d:7s">🎞️</span>
            <span class="doodle" style="--x:6%;--y:70%;--d:8s">⭐</span>
            <span class="doodle" style="--x:92%;--y:65%;--d:9s">🎬</span>
        </div>

        <!-- LEGEND -->
        <div class="legend mb-3 d-flex flex-wrap gap-2 justify-content-center">
            <span class="chip"><span class="dot dot-avail"></span> Available</span>
            <span class="chip"><span class="dot dot-sel"></span> Selected</span>
            <span class="chip"><span class="dot dot-held"></span> Held</span>
            <span class="chip"><span class="dot dot-book"></span> Booked</span>
            <span class="chip"><span class="dot dot-blk"></span> Blocked</span>
        </div>

        <!-- SEAT GRID -->
        <div class="seat-grid">
            @foreach (var row in grouped)
            {
                <div class="row-label">@row.Key</div>
                <div class="row-seats">
                    @foreach (var s in row.OrderBy(x => x.SeatNumber))
                    {
                        bool isBlocked = s.IsDisabled
                        || s.Status == ShowSeatStatus.Blocked
                        || s.Status.ToString().Equals("BLOCKED", StringComparison.OrdinalIgnoreCase);

                        bool isBooked = s.Status == ShowSeatStatus.Booked
                        || s.Status.ToString().Equals("BOOKED", StringComparison.OrdinalIgnoreCase);

                        bool isHeld = s.Status == ShowSeatStatus.Held
                        || s.Status.ToString().Equals("HELD", StringComparison.OrdinalIgnoreCase);

                        var css = "seat";
                        bool disabled = isBlocked || isBooked || isHeld;

                        if (isBlocked) css += " blocked";
                        else if (isBooked) css += " booked";
                        else if (isHeld) css += " held";
                        else css += " available";

                        <button type="button"
                                class="@css"
                                data-id="@s.SeatId"
                                data-price="@s.Price"
                                data-label="@($"{s.RowLabel}{s.SeatNumber}")"
                                @(disabled ? "disabled" : null)>
                            <div class="seat-no">@s.SeatNumber</div>
                            <div class="seat-price">৳@s.Price.ToString("0.00")</div>
                        </button>
                    }
                </div>
            }
        </div>

        <!-- THEATRE SCREEN (glow upward) -->
        <div class="screen-wrap">
            <div class="screen-glow"></div>
            <div class="screen-bar"></div>
        </div>
    </div>

    <!-- CART -->
    <div id="cart" class="card glass-card mt-4">
        <div class="card-header">Selected seats</div>
        <div class="card-body">
            <div id="selected-list" class="small text-muted">None</div>
            <div class="mt-2">
                <strong>Total: </strong><span id="total">৳0.00</span>
            </div>

            <form asp-controller="ShowSeats" asp-action="Proceed" method="post" class="mt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="showId" value="@Model.ShowId" />
                <input type="hidden" id="selectedSeatsInput" name="seatIds" />
                <button type="submit" class="btn btn-primary px-4" id="proceedBtn" disabled>
                    Get Ticket ✨
                </button>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/showseats/showseats-map.css" asp-append-version="true" />
}
@section Scripts {
    <script src="~/js/showseats-map.js" asp-append-version="true"></script>
}
